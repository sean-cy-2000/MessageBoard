<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <!-- 新增留言區 -->
        <div class="row mb-3">
            <div class="col-md-8">
                <input type="text" id="newMessage" class="form-control" placeholder="輸入新留言">
            </div>
            <div class="col-md-4">
                <button id="addMessage" class="btn btn-primary w-100">新增留言</button>
            </div>
        </div>

        <!-- 功能按鈕區 -->
        <div class="row mb-3">
            <div class="col-md-3">
                <button id="getMessages" class="btn btn-secondary w-100">刷新</button>
            </div>
            <div class="col-md-3">
                <button id="deleteMessages" class="btn btn-danger w-100">刪除所有</button>
            </div>
            <div class="col-md-3">
                <button id="deleteSelectedMessages" class="btn btn-warning w-100">刪除選取</button>
            </div>
            <div class="col-md-3">
                <button id="searchButton" class="btn btn-info w-100">搜尋</button>
            </div>
        </div>

        <!-- 搜尋區 -->
        <div class="row mb-3">
            <div class="col-12">
                <input type="text" id="searchKeyword" class="form-control" placeholder="輸入搜尋關鍵字">
            </div>
        </div>

        <!-- 留言列表區 -->
        <div class="mt-4">
            <ul id="messageList" class="list-group"></ul>
        </div>
    </div>

    <script>
        (() => {
            const messageList = document.getElementById('messageList');

            const fetchMessages = async () => {
                try {
                    const response = await fetch('/api/messages');
                    const data = await response.json();
                    messageList.innerHTML = data.map(({ _id, text }) => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2" data-id="${_id}">
                                <span class="message-text">${text}</span>
                                <input type="text" class="form-control d-none message-input" value="${text}">
                            </div>
                            <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${_id}">編輯</button>
                        </li>
                    `).join('');
                    addEditListeners();
                } catch (error) {
                    console.error('錯誤訊息:', error);
                }
            };

            // 改
            messageList.addEventListener('click', async (event) => {
                if (event.target.classList.contains('edit-btn')) {
                    const button = event.target;
                    const li = button.closest('li');
                    const messageText = li.querySelector('.message-text');
                    const messageInput = li.querySelector('.message-input');

                    if (button.textContent === '編輯') {
                        messageText.classList.add('d-none');
                        messageInput.classList.remove('d-none');
                        button.textContent = '確定';
                    } else {
                        await updateMessage(button.dataset.id, messageInput.value);
                        messageText.textContent = messageInput.value;
                        messageText.classList.remove('d-none');
                        messageInput.classList.add('d-none');
                        button.textContent = '編輯';
                    }
                }
            });

            const updateMessage = async (id, newText) => {
                try {
                    const response = await fetch(`/api/messages/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: newText })
                    });
                    if (!response.ok) throw new Error('Failed to update message');
                } catch (error) {
                    console.error('更新錯誤:', error);
                }
            };

            // 刪
            const deleteSelectedMessages = async () => {
                const checkboxes = document.querySelectorAll('.form-check-input:checked');
                const ids = Array.from(checkboxes).map(cb => cb.dataset.id);
                if (ids.length === 0) return;

                try {
                    await Promise.all([
                        fetch('/api/messages', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ids })
                        }),
                        ...ids.map(id => fetch(`/api/messages/${id}`, { method: 'DELETE' }))
                    ]);
                    fetchMessages();
                } catch (error) {
                    console.error('刪除錯誤:', error);
                }
            };

            const eventHandlers = {
                addMessage: async () => {
                    const newMessage = document.getElementById('newMessage').value;
                    if (newMessage) {
                        try {
                            await fetch('/api/messages', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ text: newMessage })
                            });
                            document.getElementById('newMessage').value = '';
                            fetchMessages();
                        } catch (error) {
                            console.error('錯誤訊息:', error);
                        }
                    }
                },
                deleteAllMessages: async () => {
                    try {
                        await fetch('/api/messages', { method: 'DELETE' });
                        fetchMessages();
                    } catch (error) {
                        console.error('錯誤訊息:', error);
                    }
                },
                searchMessages: async () => {
                    const keyword = document.getElementById('searchKeyword').value;
                    try {
                        const response = await fetch(`/api/search?keyword=${encodeURIComponent(keyword)}`);
                        const data = await response.json();
                        if (Array.isArray(data)) {
                            messageList.innerHTML = data.map(({ _id, text }) => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input me-2" data-id="${_id}">
                                        <span class="message-text">${text}</span>
                                        <input type="text" class="form-control d-none message-input" value="${text}">
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${_id}">編輯</button>
                                </li>
                            `).join('');
                            addEditListeners();
                        } else {
                            console.error('搜索結果格式不正確');
                        }
                    } catch (error) {
                        console.error('搜索錯誤:', error);
                    }
                }
            };

            const { addMessage, deleteAllMessages, searchMessages } = eventHandlers;
            document.getElementById('addMessage').addEventListener('click', addMessage);
            document.getElementById('deleteMessages').addEventListener('click', deleteAllMessages);
            document.getElementById('deleteSelectedMessages').addEventListener('click', deleteSelectedMessages);
            document.getElementById('searchButton').addEventListener('click', searchMessages);
            document.getElementById('getMessages').addEventListener('click', fetchMessages);

            fetchMessages();
        })();
    </script>
</body>

</html>